apiVersion: v1
kind: ConfigMap
metadata:
  name: clamav-config
data:
  clamd.conf: |
    # /etc/clamav/clamd.conf
    # Configuración MÍNIMA para el demonio ClamAV (clamd)

    # --- Configuración de Logging ---
    LogFile /var/log/clamav/clamd.log
    LogFileMaxSize 1M
    LogTime yes

    # --- Archivos de Estado ---
    PidFile /var/run/clamav/clamd.pid

    # --- Configuración de Base de Datos ---
    DatabaseDirectory /var/lib/clamav
    OfficialDatabaseOnly true

    # --- Configuración de Red (¡CRÍTICO para escanear de forma remota!) ---
    TCPSocket 3310
    TCPAddr 0.0.0.0

    # --- Seguridad ---
    User clamav

    # --- Límites de Escaneo (manteniendo los valores por defecto o sensatos) ---
    StreamMaxLength 0
    MaxScanSize 200M
    MaxFileSize 50M
    MaxRecursion 16
    MaxFiles 100000

    # --- Opciones de Escaneo Específicas ---
 
    #Escanea correos electrónicos.  
    ScanMail yes

    #Escanea archivos comprimidos (zip, rar, tar, etc.).  
    ScanArchive yes
 
    # #Tamaño máximo de archivo dentro de un archivo comprimido.  
    # ArchiveMaxFileSize 25M`
    # Nivel máximo de recursión al descomprimir archivos.  
    #ArchiveMaxRecursion 10

    #Escanea archivos PDF.  
    ScanPDF yes

    #Escanea archivos OLE2 (documentos de MS Office antiguos).  
    ScanOLE2 yes

    #Escanea archivos Flash (SWF).  
    ScanSWF yes

    #Escanea archivos ejecutables de Windows (PE).  
    ScanPE yes

    #Escanea archivos ejecutables de Linux (ELF).  
    ScanELF yes

    #Escanea archivos HTML.  
    ScanHTML yes

    #Escanea documentos XML.  
    ScanXMLDOCS yes

    #Escanea archivos Hangul Word Processor.  
    ScanHWP3 yes

    #Escanea mensajes de correo incompletos.  
    ScanPartialMessages yes

    #Habilita la detección de firmas de phishing.  
    PhishingSignatures yes

    #Escanea URLs en busca de phishing.  
    PhishingScanURLs yes

    #Da prioridad a los resultados heurísticos.  
    HeuristicScanPrecedence yes

    #Detecta aplicaciones potencialmente no deseadas.  
    DetectPUA yes

    #Excluye ciertas categorías de PUA.  
    #ExcludePUA Tool,NetTool

    #Incluye solo ciertas categorías de PUA.  
    #IncludePUA Adware

    #Detecta ejecutables dañados.  
    DetectBrokenExecutables yes

    #Habilita la detección algorítmica avanzada.  
    AlgorithmicDetection yes

    #Habilita el escaneo en tiempo real (si está soportado).  
    #ScanOnAccess yes

    # --- Auto-comprobación ---
    SelfCheck 300

  freshclam.conf: |
    # /etc/clamav/freshclam.conf
    # Configuración para el actualizador de bases de datos de ClamAV (freshclam)

    # --- Logging ---
    # Log al archivo especificado. En un contenedor, es mejor capturar stdout/stderr
    # para que Kubernetes gestione los logs. Asegúrate de que el directorio exista y sea escribible.
    # Si el contenedor redirige stdout/stderr del proceso, puedes dejar esto como está.
    # LogFile /var/log/clamav/freshclam.log
    # LogFileMaxSize 1M
    # LogTime yes

    # --- Notificación de Clamd ---
    # ¡CRÍTICO para que clamd use las nuevas definiciones sin reiniciar!
    # Le dice a freshclam dónde encontrar la configuración de clamd.
    NotifyClamd /etc/clamav/clamd.conf

    # Cómo freshclam debe conectar a clamd para la notificación.
    # Ya que clamd está en el mismo pod y escucha en TCP, usamos localhost y el puerto.
    ClamdSocket TCPAddr 127.0.0.1
    ClamdSocket TCPPort 3310

    # Asegúrate de que las opciones de socket Unix estén comentadas.
    # ClamdSocket unix:/tmp/clamd.sock
    # ClamdSocket unix:///var/run/clamav/clamd.ctl

    # --- Base de Datos ---
    # Directorio donde freshclam guardará las bases de datos.
    # Debe coincidir con el DatabaseDirectory en clamd.conf y ser el mountPath de tu PVC.
    DatabaseDirectory /var/lib/clamav

    # Solo descargar bases de datos oficiales de ClamAV.
    OfficialDatabaseOnly yes

    # Permite descargar bases de datos suplementarias de terceros.
    # Descomenta esto y configura otras opciones si planeas usarlas (ej. Sanesecurity).
    # AllowSupplementaryDatabase yes

    # --- Programación de Actualizaciones ---
    # Número de comprobaciones de actualización por día.
    # Por defecto, 12 veces al día (cada 2 horas). Puedes ajustarlo.
    # Si lo ejecutas como CronJob, puedes ponerlo a 1 o 0 (si el CronJob gestiona la frecuencia).
    Checks 12 

    # --- Proxy (si es necesario) ---
    # Si tu cluster necesita un proxy para acceder a internet.
    # HTTPProxy myproxy.com:8080

    # --- Seguridad ---
    # Usuario bajo el que se ejecutará freshclam. Debe tener permisos de escritura en DatabaseDirectory.
    User clamav

    # --- Otras Opciones Útiles ---
    # Desactivar la validación del certificado SSL del espejo (no recomendado a menos que sea necesario).
    # DisableCertCheck yes

    # Permite que freshclam continúe incluso si hay errores al cargar ciertas definiciones.
    # Esto es útil en initContainers para que clamd pueda arrancar aunque algo falle.
    # En un demonio freshclam continuo, la notificación es más importante.
    # ExitOnDBLoadError no 

    # Fuerza una descarga de la base de datos completa en lugar de una actualización incremental.
    # Esto puede ser útil para la primera ejecución o para solucionar problemas de corrupción.
    # Se usa típicamente con un comando freshclam --force-update.
    # ForceUpdate yes     
